package io.zeitwert.ddd.session;

import org.springframework.beans.factory.BeanFactory;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;

import io.zeitwert.dddrive.app.model.SessionContext;
import io.dddrive.app.service.api.AppContextSPI;
import io.dddrive.app.service.api.base.AppContextBase;

@Configuration
@Profile({ "test", "ci" })
public class TestAppContextProvider {

	@Bean("appContext")
	public AppContextSPI appContext(
			ApplicationEventPublisher applicationEventPublisher,
			BeanFactory beanFactory,
			RequestContext sessionContext) {
		return new TestAppContextImpl(applicationEventPublisher, beanFactory, sessionContext);
	}

	/**
	 * Test implementation of AppContext that extends AppContextBase.
	 * Uses the RequestContext bean provided by TestRequestContextProvider.
	 */
	private static class TestAppContextImpl extends AppContextBase {

		private final RequestContext sessionContext;

		protected TestAppContextImpl(
				ApplicationEventPublisher applicationEventPublisher,
				BeanFactory beanFactory,
				RequestContext sessionContext) {
			super(applicationEventPublisher, beanFactory);
			this.sessionContext = sessionContext;
		}

		@Override
		public RequestContext getRequestContext() {
			return this.sessionContext;
		}

		@Override
		public void beginKernelSession(String userEmail) {
			// No-op for tests - RequestContext is already provided by TestRequestContextProvider
		}

		@Override
		public void endKernelSession() {
			// No-op for tests
		}
	}
}

